---
- name: Install CRC
  hosts: localhost

  vars:
    crc_version: "1.10.0"
    crc_url_file: "https://mirror.openshift.com/pub/openshift-v4/clients/crc/{{crc_version}}/crc-linux-amd64.tar.xz"
    crc_tmp_dest: "/tmp/crc-linux-{{crc_version}}-amd64.tar.xz"
    crc_package_name: "crc-linux-{{crc_version}}-amd64"

  tasks:

    - name: Create .local/bin/
      file:
        path: /home/{{ansible_user_id}}/.local/bin/
        state: directory

    - name: Check if crc exists in /home/{{ansible_user_id}}/.local/bin/
      stat:
        path: "/home/{{ ansible_user_id }}/.local/bin/crc"
      register: stat_result

    - name: Check if {{ crc_package_name }}/crc exists in /tmp/
      stat:
        path: "/tmp/{{ crc_package_name }}/crc"
      register: stat_result

    - name: "Download crc {{ crc_version }} ~2GB, this takes time and depends on your connection speed"
      get_url:
        url: "{{ crc_url_file }}"
        dest: "{{ crc_tmp_dest }}"
      when: stat_result.stat.exists == False

    - name: Extract {{ crc_package_name }}.tar.xz into tmp
      unarchive:
        src: "{{ crc_tmp_dest }}"
        dest: /tmp
      when: stat_result.stat.exists == False

    - name: Check if {{ crc_package_name }}/crc exists in /tmp/
      stat:
        path: "/tmp/{{ crc_package_name }}/crc"
      register: stat_result

    - name: Check if crc exists in /home/{{ansible_user_id}}/.local/bin/
      stat:
        path: "/home/{{ ansible_user_id }}/.local/bin/crc"
      register: stat_result
      when: stat_result.stat.exists == True

    - name: Move crc from /tmp/crc-linux-{{crc_version}}-amd64 to /home/{{ansible_user_id}}/.local/bin
      command: "mv /tmp/{{ crc_package_name }}/crc /home/{{ansible_user_id}}/.local/bin/"
      when: stat_result.stat.exists == False

    - name: crc libvirt group
      shell: "crc config set skip-check-user-in-libvirt-group true"